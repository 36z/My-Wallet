function exceptionToString(e){var t="";for(var n in e){t+="property: "+n+" value: ["+e[n]+"]\n"}return"toString(): "+" value: ["+e.toString()+"]"}function generateNewMiniPrivateKey(){while(true){var e=new Bitcoin.ECKey(false);var t="S"+Bitcoin.Base58.encode(e.priv).substr(0,21);var n=Crypto.SHA256(t+"?",{asBytes:true});if(n[0]==0){var r=Crypto.SHA256(t,{asBytes:true});var i=new Bitcoin.ECKey(r);if(MyWallet.addPrivateKey(i))return{key:i,miniKey:t}}}}function IsCanonicalSignature(e){if(e.length<9)throw"Non-canonical signature: too short";if(e.length>73)throw"Non-canonical signature: too long";var t=e[e.length-1];if(t!=Bitcoin.Transaction.SIGHASH_ALL&&t!=Bitcoin.Transaction.SIGHASH_NONE&&t!=Bitcoin.Transaction.SIGHASH_SINGLE&&t!=Bitcoin.Transaction.SIGHASH_ANYONECANPAY)throw"Non-canonical signature: unknown hashtype byte "+t;if(e[0]!=48)throw"Non-canonical signature: wrong type";if(e[1]!=e.length-3)throw"Non-canonical signature: wrong length marker";var n=e[3];if(5+n>=e.length)throw"Non-canonical signature: S length misplaced";var r=e[5+n];if(n+r+7!=e.length)throw"Non-canonical signature: R+S length mismatch";var i=4;if(e[i-2]!=2)throw"Non-canonical signature: R value type mismatch";if(n==0)throw"Non-canonical signature: R length is zero";if(e[i+0]&128)throw"Non-canonical signature: R value negative";if(n>1&&e[i+0]==0&&!(e[i+1]&128))throw"Non-canonical signature: R value excessively padded";var i=6+n;if(e[i-2]!=2)throw"Non-canonical signature: S value type mismatch";if(r==0)throw"Non-canonical signature: S length is zero";if(e[i+0]&128)throw"Non-canonical signature: S value negative";if(r>1&&e[i+0]==0&&!(e[i+1]&128))throw"Non-canonical signature: S value excessively padded";return true}function showPrivateKeyModal(e,t,n){var r=$("#private-key-modal");r.modal({keyboard:true,backdrop:"static",show:true});r.center();r.find(".address").text(n);var i=null;var s=false;var o=null;var u=r.find('input[name="key"]');u.val("");r.find(".qrcodeicon span").click(function(){r.modal("hide");MyWallet.scanQRCode(function(e){console.log("Scanned "+e);r.modal("show");u.val(e);r.find(".btn.btn-primary").trigger("click")},function(e){r.modal("show");MyWallet.makeNotice("error","misc-error",e)})});r.find(".btn.btn-primary").unbind().click(function(){var n=$.trim(u.val());try{if(n.length==0){throw"You must enter a private key to import"}var a=MyWallet.detectPrivateKeyFormat(n);console.log("PK Format "+a);if(a=="bip38"){r.modal("hide");loadScript("wallet/import-export",function(){MyWallet.getPassword($("#import-private-key-password"),function(u){ImportExport.parseBIP38toECKey(n,u,function(n,u){i=n;s=u;r.modal("hide");if(i)e(i);else t(o)},t)},t)},t);return}i=MyWallet.privateKeyStringToKey(n,a);s=a=="compsipa";if(i==null){throw"Could not decode private key"}}catch(f){o="Error importing private key "+f}r.modal("hide");if(i)e(i);else t(o)});r.find(".btn.btn-secondary").unbind().click(function(){r.modal("hide");t("User Cancelled")})}function resolveAddress(e){e=$.trim(e);try{return Bitcoin.Address.fromBase58Check(e).toString()}catch(t){}e=e.toLowerCase();var n=MyWallet.getAddressBook();for(var r in n){var i=MyWallet.getAddressBookLabel(r);if(i.toLowerCase()==e){return $.trim(r)}}var s=MyWallet.getAllAddresses();for(var o=0;o<s.length;++o){var r=s[o];var i=MyWallet.getAddressLabel(r);if(i&&i.toLowerCase()==e)return r}return null}function startTxUI(e,t,n,r){function i(){e.find('input[name="send-value"]').val("");e.find('input[name="send-to-address"]').val("")}try{e.find("input,select,button").prop("disabled",true);n.addListener({on_success:function(t){e.find("input,select,button").prop("disabled",false)},on_start:function(t){e.find("input,select,button").prop("disabled",true)},on_error:function(t){e.find("input,select,button").prop("disabled",false)}});var s=0;e.find('input[name="send-value"]').each(function(){s+=parseFloat($(this).val())});var o=true;if(s>precisionFromBTC(10)){if(t=="email"||t=="sms"){throw"Cannot Send More Than 10 BTC via email or sms"}else if(t=="quick"){t="custom";o=false}}else if(t=="shared"&&s<precisionFromBTC(.1)){throw"The Minimum Amount You Can Send Shared is "+formatPrecision(precisionFromBTC(.1))}else if(t=="shared"&&s>precisionFromBTC(250)){throw"The Maximum Amount You Can Send Shared is "+formatPrecision(precisionFromBTC(250))}if(t=="custom"||t=="shared"){var u={on_error:function(e){if(this.modal)this.modal.modal("hide")},on_success:function(){i()},on_start:function(){var e=this;this.modal=$("#new-transaction-modal");this.modal.modal({keyboard:false,backdrop:"static",show:true});this.modal.find(".offline-transaction").hide();this.modal.find("#missing-private-key").hide();this.modal.find("#review-tx").hide();this.modal.find(".modal-header h3").html("Creating transaction");this.modal.find("#tx-sign-progress").hide();this.modal.find(".btn.btn-primary").prop("disabled",true);this.modal.find(".btn.btn-primary").text("Send Transaction");this.modal.find(".btn.btn-secondary").unbind().click(function(){if(e.modal)e.modal.modal("hide");e.cancel()})},on_begin_signing:function(){$("#tx-sign-progress").show().find(".t").text(this.tx.ins.length)},on_sign_progress:function(e){$("#tx-sign-progress").find(".n").text(e)},on_finish_signing:function(){$("#tx-sign-progress").hide()}};n.addListener(u);if(o){n.ask_for_fee=function(e,t){var n=this;if(n.modal)n.modal.modal("hide");var r=$("#ask-for-fee");r.modal({keyboard:false,backdrop:"static",show:true});r.find(".btn.btn-primary").unbind().click(function(){r.modal("hide");e()});r.find(".btn.btn-secondary").unbind().click(function(){r.modal("hide");t()});r.unbind().on("hidden",function(){if(n.modal)n.modal.modal("show")})};n.ask_to_increase_fee=function(e,t,n,r){var i=this;if(i.modal)i.modal.modal("hide");var s=$("#ask-to-increase-fee");s.modal({keyboard:false,backdrop:"static",show:true});var o=s.find(".modal-body");var u=o.find("span");u.eq(0).text(formatSymbol(n.intValue(),symbol_btc));u.eq(1).text(formatSymbol(r.intValue(),symbol_btc));s.find(".btn.btn-primary").unbind().click(function(){s.modal("hide");e()});s.find(".btn.btn-secondary").unbind().click(function(){s.modal("hide");t()});s.unbind().on("hidden",function(){if(i.modal)i.modal.modal("show")})}}n.ask_to_send=function(){var e=this;try{e.modal.find(".modal-header h3").html(e.ready_to_send_header);e.modal.find("#missing-private-key").hide();e.modal.find("#review-tx").show();setReviewTransactionContent(e.modal,e.tx,e.sendTxInAmounts,e.sendTxOutAmounts,e.type);setAdv(false);e.modal.center();var t=e.modal.find(".btn.btn-primary");MyWallet.setLoadingText("Checking Connectivity");$.ajax({timeout:6e4,type:"GET",url:root+"ping",data:{format:"plain",date:(new Date).getTime()},success:function(){t.removeAttr("disabled");t.text("Send Transaction");t.unbind().click(function(){t.prop("disabled",true);if(e.modal)e.modal.modal("hide");e.send()})},error:function(){e.modal.find(".modal-header h3").html("Created Offline Transaction.");t.removeAttr("disabled");t.text("Show Offline Instructions");t.unbind().click(function(){t.prop("disabled",true);e.modal.find("#missing-private-key").hide();e.modal.find("#review-tx").hide();e.modal.find(".offline-transaction").show();var n=e.tx.toHex();e.modal.find('.offline-transaction textarea[name="data"]').val(n)});e.modal.center()}})}catch(n){e.error(n)}}}else if(t=="quick"||t=="email"||t=="dice"||t=="sms"){var u={on_error:function(t){e.find(".send").show();if(this.p)this.p.hide()},on_success:function(){try{e.find(".send").show();if(t!="dice"){i()}if(this.p)this.p.hide()}catch(n){console.log(n)}},on_start:function(){this.p=e.find(".progress");e.find(".send").hide();this.p.show();this.p.children().css("width","10%")},on_begin_signing:function(){this.p.children().css("width","25%")},on_sign_progress:function(e){this.p.children().css("width",25+100/this.tx.ins.length*e+"%")},on_finish_signing:function(){this.p.children().css("width","100%")}};n.addListener(u);if(t=="sms"){n.ask_to_send=function(){try{var e=this;MyWallet.securePost("send-via",{type:"sms",to:e.sms_data.number,priv:e.sms_data.miniKey,hash:Crypto.util.bytesToHex(e.tx.getHash().reverse())},function(){e.send()},function(t){e.error(t?t.responseText:null)})}catch(t){e.error(t)}}}else if(t=="email"){n.ask_to_send=function(){var e=this;var t=$("#send-email-modal");try{MyWallet.securePost("wallet",{method:"get-info",format:"json"},function(n){try{t.modal({keyboard:true,backdrop:"static",show:true});var r=n.alias;if(r==null)r=n.email;if(r==null)r="Shared";t.find(".amount").text(formatBTC(e.email_data.amount.toString()));t.find(".email").text(e.email_data.email);t.find(".frame").html('<iframe frameBorder="0" style="box-sizing:border-box;width:100%;height:100%" src="'+root+"email-template?from_name="+r+"&amount="+e.email_data.amount+'&priv=Preview&type=send-bitcoins-get"></iframe>');t.find(".btn.btn-secondary").unbind().click(function(){e.cancel();t.modal("hide")});t.find(".btn.btn-primary").unbind().click(function(){t.modal("hide");try{MyWallet.securePost("send-via",{type:"email",to:e.email_data.email,priv:e.email_data.priv,hash:Crypto.util.bytesToHex(e.tx.getHash().reverse())},function(t){e.send()},function(t){e.error(t?t.responseText:null)})}catch(n){e.error(n)}})}catch(i){t.modal("hide");e.error(i)}},function(n){t.modal("hide");e.error("Error Getting Account Data")})}catch(n){t.modal("hide");e.error(n)}}}}n.insufficient_funds=function(e,t,n,r){var i=this;if(i.modal)i.modal.modal("hide");var s=$("#insufficient-funds");s.find(".amount-required").text(formatBTC(e));s.find(".amount-available").text(formatBTC(t));s.modal({keyboard:false,backdrop:"static",show:true});s.find(".btn.btn-primary").unbind().click(function(){s.modal("hide");n()});s.find(".btn.btn-secondary").unbind().click(function(){s.modal("hide");r()});s.unbind().on("hidden",function(){if(i.modal)i.modal.modal("show")})};n.ask_for_private_key=function(e,t,n){var r=this;if(r.modal)r.modal.modal("hide");showPrivateKeyModal(function(t,n){if(r.modal)r.modal.modal("show");e(t,n)},function(e){if(r.modal)r.modal.modal("show");t(e)},n)};n.type=t;if(MyWallet.getFeePolicy()==1){n.base_fee=Bitcoin.BigInteger.valueOf(1e5);n.fee=Bitcoin.BigInteger.valueOf(1e5)}else if(MyWallet.getFeePolicy()==-1){n.base_fee=Bitcoin.BigInteger.valueOf(1e4);n.ask_for_fee=function(e,t){t()}}MyWallet.getSecondPassword(function(){try{var r=e.find('select[name="from"]');var i=r.val();if(i==null||i=="any"){n.from_addresses=MyWallet.getActiveAddresses()}else if(r.attr("multiple")=="multiple"){n.from_addresses=i}else{n.from_addresses=[i]}var s=e.find('textarea[name="public-note"]').val();if(s!=null&&s.length>0){if(s.length>255)throw"Notes are restricted to 255 characters in length";n.note=s}var o=$.trim(e.find('select[name="change"]').val());if(o.length>0){if(o=="new"){var u=MyWallet.generateNewKey();var a=u.pub.getAddress();n.change_address=a;n.generated_addresses.push(a.toString())}else if(o!="any"){try{n.change_address=Bitcoin.Address.fromBase58Check(o)}catch(f){throw"Invalid change address: "+f}}}var l=e.find('input[name="fees"]').val();if(l!=null&&l.length>0){var c=precisionToSatoshiBN(l);if(c.compareTo(Bitcoin.BigInteger.ZERO)>=0){n.fee=c;n.did_specify_fee_manually=true}}var h=e.find(".recipient");if(h.length==0){throw"A transaction must have at least one recipient"}var p=h.length;var d=function(){if(p==0){n.error("Nothing to send.");return}if(n.to_addresses.length<p)return;if(n.to_addresses.length>p){n.error("We seem to have more recipients than required. Unknown error");return}n.start()};h.each(function(){try{var e=$(this);var r=e.find('input[name="send-value"]');var i=e.find('input[name="send-to-address"]');var s=e.find('input[name="send-to-email"]');var o=e.find('input[name="send-to-sms"]');var u=0;try{u=precisionToSatoshiBN(r.val());if(u==null||u.compareTo(Bitcoin.BigInteger.ZERO)<=0)throw"You must enter a value greater than zero"}catch(a){console.log(a);if(r.data("optional")==true){--p;return true}else{throw"Invalid send amount"}}if(i.length>0){var f=$.trim(i.val()).replace(/[\u200B-\u200D\uFEFF]/g,"");if(f==null||f.length==0){throw"You must enter a bitcoin address for each recipient"}else{var l=resolveAddress(f);if(t=="shared"){if(!l){throw"Invalid Bitcoin Address"}MyWallet.setLoadingText("Creating Forwarding Address");MyWallet.securePost("forwarder",{action:"create-mix",address:l,shared:true,format:"json"},function(e){try{if(e.destination!=l){throw"Mismatch between requested and returned destination address"}if(e.fee_percent!=MyWallet.getMixerFee()){MyWallet.get_history();throw"The mixer fee may have changed"}n.to_addresses.push({address:Bitcoin.Address.fromBase58Check(e.input_address),value:u});d()}catch(t){n.error(t)}},function(e){n.error(e?e.responseText:null)})}else{if(l){n.to_addresses.push({address:Bitcoin.Address.fromBase58Check(l),value:u})}else if(f.length<10){BlockchainAPI.resolve_firstbits(f,function(e){try{n.to_addresses.push({address:Bitcoin.Address.fromBase58Check(e),value:u});d()}catch(t){n.error(t)}},function(){n.error("Invalid to address: "+f)});return false}else{n.error("Invalid to address: "+f)}}}}else if(o.length>0){var c=$.trim(o.val());if(c.charAt(0)=="0")c=c.substring(1);if(c.charAt(0)!="+")c="+"+e.find('select[name="sms-country-code"]').val()+c;var h=generateNewMiniPrivateKey();var l=h.key.getBitcoinAddress().toString();MyWallet.setAddressTag(l,2);MyWallet.setAddressLabel(l,c+" Sent Via SMS");n.generated_addresses.push(l);n.to_addresses.push({address:Bitcoin.Address.fromBase58Check(l),value:u});if(n.sms_data)throw"Cannot send to more than one SMS recipient at a time";n.sms_data={number:c,miniKey:h.miniKey}}else if(s.length>0){var v=$.trim(s.val());function m(e){var t=e.lastIndexOf("@");var n=e.lastIndexOf(".");return t<n&&t>0&&e.indexOf("@@")==-1&&n>2&&e.length-n>2}if(m(v)){var g=MyWallet.generateNewKey();var l=g.getBitcoinAddress().toString();MyWallet.setAddressTag(l,2);MyWallet.setAddressLabel(l,v+" Sent Via Email");n.generated_addresses.push(l);n.to_addresses.push({address:Bitcoin.Address.fromBase58Check(l),value:u});if(n.email_data)throw"Cannot send to more than one email recipient at a time";n.email_data={email:v,priv:B58.encode(g.priv),amount:u}}else{throw"Invalid Email Address"}}}catch(a){console.log(a);n.error(a)}});d()}catch(f){n.error(f)}},function(){n.error()})}catch(a){n.error(a)}return n}function signInput(e,t,n,r,i){i=i?i:Bitcoin.Transaction.SIGHASH_ALL;var s=Bitcoin.Address.fromOutputScript(r);var o=new Bitcoin.ECKey(new Bitcoin.BigInteger.fromBuffer(n),false);if(MyWallet.getUnCompressedAddressString(o)==s.toString()){}else if(MyWallet.getCompressedAddressString(o)==s.toString()){o=new Bitcoin.ECKey(o.d,true)}else{throw"Private key does not match bitcoin address "+s.toString()+" = "+MyWallet.getUnCompressedAddressString(o)+" | "+MyWallet.getCompressedAddressString(o)}var u=e.signInput(t,r,o);if(!IsCanonicalSignature(u)){throw"IsCanonicalSignature returned false"}e.setInputScript(t,Bitcoin.scripts.pubKeyHashInput(u,o.pub));if(e.ins[t].script==null){throw"Error creating input script"}return e.ins[t].script}function formatAddresses(e,t,n){var r="";if(t.length==1){var i=t[0].toString();if(n&&MyWallet.addressExists(i)&&MyWallet.getAddressLabel(i))r=MyWallet.getAddressLabel(i);else if(n&&MyWallet.getAddressBookLabel(i))r=MyWallet.getAddressBookLabel(i);else r=i}else{r="Escrow (<i>";for(var s=0;s<t.length;++s){r+=t[s].toString()+", "}r=r.substring(0,r.length-2);r+="</i> - "+e+" Required)"}return r}function setReviewTransactionContent(e,t,n,r,i){$("#rtc-hash").html(t.getId());$("#rtc-version").html(t.version);$("#rtc-from").html("");$("#rtc-to").html("");var s=Bitcoin.BigInteger.ZERO;var o=Bitcoin.BigInteger.ZERO;var u=Bitcoin.BigInteger.ZERO;var a="send ";var f=true;var l=Bitcoin.BigInteger.ZERO;for(var c=0;c<t.ins.length;++c){var h=t.ins[c];o=o.add(n[c]);u=u.add(n[c]);var p=null;try{p=new Bitcoin.Address(MyWallet.simpleInPubKeyHash(h.script),Bitcoin.networks.bitcoin.pubKeyHash)}catch(d){p="Unable To Decode Address"}$("#rtc-from").append(p+' <font color="green">'+formatBTC(n[c].toString())+" <br />")}var v=true;for(var c=0;c<t.outs.length;++c){var m=t.outs[c];var g=r[c];var y=[];var b=1;try{b=MyWallet.extractAddresses(m.script,y)}catch(d){y.push("Unknown Address!")}$("#rtc-to").append(formatAddresses(b,y)+' <font color="green">'+formatBTC(g.toString())+" </font><br />");s=s.add(g);o=o.subtract(g);if(y.length>1){if(!v){a+=" and "}a+="<b>"+formatBTC(g.toString())+"</b> to "+formatAddresses(b,y,true);f=false;u=u.subtract(g)}else if(y.length>0){var w=y[0].toString();if(!MyWallet.addressExists(w)||MyWallet.getAddressTag(w)==2){if(g.compareTo(Bitcoin.BigInteger.ZERO)==0)continue;if(!v){a+=" and "}if(i&&i=="shared"){a+="<b>"+formatBTC(g.toString())+"</b> Shared"}else{a+="<b>"+formatBTC(g.toString())+"</b> to "+formatAddresses(1,[w],true)}f=false}else{u=u.subtract(g);l=l.add(g)}}v=false}if(o.compareTo(Bitcoin.BigInteger.valueOf(1).multiply(Bitcoin.BigInteger.valueOf(satoshi)))>=0){alert("Warning fees are very high for this transaction. Please double check each output!")}if(f==true){a="move <b>"+formatBTC(s.toString())+"</b> between your own bitcoin addresses"}$("#rtc-basic-summary").html(a);$("#rtc-effect").html("-"+formatBTC(u.toString()));$("#rtc-fees").html(formatBTC(o.toString()));$("#rtc-value").html(formatBTC(s.toString()))}function initNewTx(){var e={generated_addresses:[],to_addresses:[],fee:Bitcoin.BigInteger.ZERO,extra_private_keys:{},listeners:[],is_cancelled:false,base_fee:Bitcoin.BigInteger.valueOf(1e4),min_free_output_size:Bitcoin.BigInteger.valueOf(1e6),allow_adjust:true,ready_to_send_header:"Transaction Ready to Send.",min_input_confirmations:0,do_not_use_unspent_cache:false,min_input_size:Bitcoin.BigInteger.ZERO,did_specify_fee_manually:false,sendTxInAmounts:[],sendTxOutAmounts:[],addListener:function(e){this.listeners.push(e)},invoke:function(e,t,n){for(var r in this.listeners){try{if(this.listeners[r][e])this.listeners[r][e].call(this,t,n)}catch(i){console.log(i)}}},start:function(){var e=this;try{e.invoke("on_start");BlockchainAPI.get_unspent(e.from_addresses,function(t){try{if(e.is_cancelled){throw"Transaction Cancelled"}if(t.unspent_outputs==null||t.unspent_outputs.length==0){throw"No Free Outputs To Spend"}e.unspent=[];for(var n=0;n<t.unspent_outputs.length;++n){var r;try{r=Bitcoin.Script.fromHex(t.unspent_outputs[n].script);if(Bitcoin.scripts.classifyOutput(r)=="nonstandard")throw"Strange Script"}catch(i){MyWallet.makeNotice("error","misc-error","Error decoding script: "+i);continue}var s={script:r,value:Bitcoin.BigInteger.fromByteArrayUnsigned(Crypto.util.hexToBytes(t.unspent_outputs[n].value_hex)),tx_output_n:t.unspent_outputs[n].tx_output_n,tx_hash:t.unspent_outputs[n].tx_hash,confirmations:t.unspent_outputs[n].confirmations};e.unspent.push(s)}e.makeTransaction()}catch(i){e.error(i)}},function(t){e.error(t)},e.min_input_confirmations,e.do_not_use_unspent_cache)}catch(t){e.error(t)}},isSelectedValueSufficient:function(e,t){return t.compareTo(e)==0||t.compareTo(e.add(this.min_free_output_size))>=0},makeTransaction:function(){var e=this;try{if(e.is_cancelled){throw"Transaction Cancelled"}e.selected_outputs=[];var t=Bitcoin.BigInteger.ZERO;for(var n=0;n<e.to_addresses.length;++n){t=t.add(e.to_addresses[n].value)}var r=Bitcoin.BigInteger.ZERO;if(e.fee!=null){t=t.add(e.fee)}var i=0;var s=[];var o=false;var u=e.unspent.slice(0);function a(e){var t=Bitcoin.Address.fromOutputScript(e.script).toString();if(t==null){throw"Unable to decode output address from transaction hash "+e.tx_hash}if(e.script==null){throw"Output script is null ("+e.tx_hash+":"+e.tx_output_n+")"}var n=new Bitcoin.Buffer.Buffer(e.tx_hash,"hex");Array.prototype.reverse.call(n);var r={outpoint:{hash:n.toString("hex"),index:e.tx_output_n,value:e.value},script:e.script,sequence:4294967295};return{addr:t,transactionInputDict:r}}var f=false;while(true){for(var n=0;n<u.length;++n){var l=u[n];if(!l)continue;try{var c=a(l);if(!f&&MyWallet.isWatchOnly(c.addr)){continue}if(e.from_addresses!=null&&$.inArray(c.addr,e.from_addresses)==-1){continue}if(l.value.compareTo(e.min_input_size)<0){continue}if(l.value.compareTo(t)==0||e.isSelectedValueSufficient(t,l.value)){e.selected_outputs=[c.transactionInputDict];u[n]=null;s=[c.addr];i=l.value.intValue()*l.confirmations;r=l.value;break}else{e.selected_outputs.push(c.transactionInputDict);u[n]=null;s.push(c.addr);i+=l.value.intValue()*l.confirmations;r=r.add(l.value);if(e.isSelectedValueSufficient(t,r))break}}catch(h){MyWallet.makeNotice("info","tx-error",h)}}if(e.isSelectedValueSufficient(t,r))break;if(f)break;f=true}function p(){e.error("Insufficient funds. Value Needed "+formatBTC(t.toString())+". Available amount "+formatBTC(r.toString()))}var d=r.subtract(t);if(d.compareTo(Bitcoin.BigInteger.ZERO)<0){if(e.to_addresses.length==1&&r.compareTo(Bitcoin.BigInteger.ZERO)>0&&e.allow_adjust){e.insufficient_funds(t,r,function(){var n=e.to_addresses[0].value.add(d);if(n.compareTo(Bitcoin.BigInteger.ZERO)>0&&n.compareTo(t)<=0){e.to_addresses[0].value=n;e.makeTransaction();return}else{p()}},function(){p()})}else{p()}return}if(e.selected_outputs.length==0){e.error("No Available Outputs To Spend.");return}var v=new Bitcoin.Transaction;this.sendTxInAmounts=[];for(var n=0;n<e.selected_outputs.length;n++){var m=e.selected_outputs[n];v.addInput(m.outpoint.hash,m.outpoint.index);this.sendTxInAmounts.push(m.outpoint.value)}this.sendTxOutAmounts=[];for(var n=0;n<e.to_addresses.length;++n){var g=e.to_addresses[n];if(g.m!=null){v.addOutputScript(Bitcoin.scripts.multisigOutput(g.m,g.pubkeys),parseInt(g.value));this.sendTxOutAmounts.push(g.value)}else{v.addOutput(g.address,parseInt(g.value));this.sendTxOutAmounts.push(g.value)}if(g.value.compareTo(e.min_free_output_size)<0){o=true}}var y=r.subtract(t);if(y.compareTo(Bitcoin.BigInteger.ZERO)>0){if(e.change_address!=null)v.addOutput(e.change_address,parseInt(y));else if(s.length>0){v.addOutput(Bitcoin.Address.fromBase58Check(s[Math.floor(Math.random()*s.length)]),parseInt(y))}else{v.addOutput(Bitcoin.Address.fromBase58Check(MyWallet.getPreferredAddress()),parseInt(y))}this.sendTxOutAmounts.push(y);if(y.compareTo(e.min_free_output_size)<0){o=true}}var b=v.toHex().length/2+138*v.ins.length;i/=b;var w=Math.max(1,Math.ceil(parseFloat(b/1e3)));var E=!e.fee||e.fee.compareTo(e.base_fee)<0;var S=function(){e.fee=e.base_fee.multiply(Bitcoin.BigInteger.valueOf(w));e.makeTransaction()};if(E&&(o||w>1)){if(e.fee&&e.did_specify_fee_manually){e.ask_to_increase_fee(function(){S()},function(){e.tx=v;e.determinePrivateKeys(function(){e.signInputs()})},e.fee,e.base_fee.multiply(Bitcoin.BigInteger.valueOf(w)))}else{S()}}else if(E&&(MyWallet.getRecommendIncludeFee()||i<776e5)){e.ask_for_fee(function(){S()},function(){e.tx=v;e.determinePrivateKeys(function(){e.signInputs()})})}else{e.tx=v;e.determinePrivateKeys(function(){e.signInputs()})}}catch(h){this.error(h)}},ask_for_fee:function(e,t){e()},ask_to_increase_fee:function(e,t,n,r){e()},insufficient_funds:function(e,t,n,r){r()},determinePrivateKeys:function(e){var t=this;try{if(t.is_cancelled){throw"Transaction Cancelled"}if(t.selected_outputs.length!=t.tx.ins.length){throw"Selected Outputs Count != Tx Inputs Length"}var n={};for(var r=0;r<t.selected_outputs.length;++r){var i=t.selected_outputs[r].script;if(i==null){console.log("Output:");console.log(t.selected_outputs[r]);throw"determinePrivateKeys() Connected script is null"}if(i.priv_to_use==null){var s=Bitcoin.Address.fromOutputScript(i).toString();if(n[s]){i.priv_to_use=n[s]}else if(t.extra_private_keys&&t.extra_private_keys[s]){i.priv_to_use=Bitcoin.Base58.decode(t.extra_private_keys[s])}else if(MyWallet.addressExists(s)&&!MyWallet.isWatchOnly(s)){try{i.priv_to_use=MyWallet.decodePK(MyWallet.getPrivateKey(s))}catch(o){console.log(o)}}if(i.priv_to_use==null){t.ask_for_private_key(function(n){try{if(s==MyWallet.getUnCompressedAddressString(n)||s==MyWallet.getCompressedAddressString(n)){t.extra_private_keys[s]=Bitcoin.Base58.encode(n.priv);t.determinePrivateKeys(e)}else{throw"The private key you entered does not match the bitcoin address"}}catch(r){t.error(r)}},function(e){t.from_addresses=$.grep(t.from_addresses,function(e){return e!=s});t.makeTransaction()},s);return false}else{n[s]=i.priv_to_use}}}e()}catch(o){t.error(o)}},signWebWorker:function(e,t){var n=false;var r=function(e){if(!n){t(e);n=true}};try{var i=this;var s=0;var o=Math.min(3,i.tx.ins.length);var u=new SecureRandom;i.worker=[];for(var a=0;a<o;++a){i.worker[a]=new Worker(MyWallet.getWebWorkerLoadPrefix()+"signer"+(min?".min.js":".js"));i.worker[a].addEventListener("message",function(t){var n=t.data;try{switch(n.cmd){case"on_sign":i.invoke("on_sign_progress",parseInt(n.outputN)+1);i.tx.ins[n.outputN].script=new Bitcoin.Script(n.script);++s;if(s==i.tx.ins.length){i.terminateWorkers();e()}break;case"on_message":{console.log(n.message);break};case"on_error":{throw n.e}}}catch(t){i.terminateWorkers();r(t)}},false);i.worker[a].addEventListener("error",function(e){r(e)});i.worker[a].postMessage({cmd:"load_resource",path:MyWallet.getWebWorkerLoadPrefix()+"bitcoinjs"+(min?".min.js":".js")});var f=new Array(32);u.nextBytes(f);i.worker[a].postMessage({cmd:"seed",seed:Crypto.util.bytesToHex(f)})}for(var l=0;l<i.selected_outputs.length;++l){var c=i.selected_outputs[l].script;if(c==null){throw"signWebWorker() Connected Script Is Null"}i.worker[l%o].postMessage({cmd:"sign_input",tx:i.tx,outputN:l,priv_to_use:c.priv_to_use,connected_script:c})}}catch(h){r(h)}},signNormal:function(e,t){var n=this;var r=0;var i=function(){setTimeout(function(){if(n.is_cancelled){t();return}try{n.invoke("on_sign_progress",r+1);var s=n.selected_outputs[r].script;if(s==null){throw"signNormal() Connected Script Is Null"}var o=signInput(n.tx,r,s.priv_to_use,s);if(o){n.tx.ins[r].script=o;r++;if(r==n.tx.ins.length){e()}else{i()}}else{throw"Unknown error signing transaction"}}catch(u){t(u)}},1)};i()},signInputs:function(){var e=this;try{e.invoke("on_begin_signing");var t=function(){e.invoke("on_finish_signing");e.is_ready=true;e.ask_to_send()};MyWallet._seed();e.signWebWorker(t,function(n){console.log(n);e.signNormal(t,function(t){e.error(t)})})}catch(n){e.error(n)}},terminateWorkers:function(){if(this.worker){for(var e=0;e<this.worker.length;++e){try{this.worker[e].terminate()}catch(t){}}}},cancel:function(){if(!this.has_pushed){this.terminateWorkers();this.error("Transaction Cancelled")}},send:function(){var e=this;if(e.is_cancelled){e.error("This transaction has already been cancelled");return}if(!e.is_ready){e.error("Transaction is not ready to send yet");return}e.invoke("on_before_send");if(e.generated_addresses.length>0){e.has_saved_addresses=true;MyWallet.backupWallet("update",function(){e.pushTx()},function(){e.error("Error Backing Up Wallet. Cannot Save Newly Generated Keys.")})}else{e.pushTx()}},pushTx:function(){var e=this;if(e.is_cancelled)return;e.has_pushed=true;BlockchainAPI.push_tx(e.tx,e.note,function(t){e.success(t)},function(t){e.error(t)})},ask_for_private_key:function(e,t){t("Cannot ask for private key without user interaction disabled")},ask_to_send:function(){this.send()},error:function(e){if(this.is_cancelled)return;this.is_cancelled=true;if(!this.has_pushed&&this.generated_addresses.length>0){for(var t=0;t<this.generated_addresses.length;++t){MyWallet.deleteAddress(this.generated_addresses[t])}if(this.has_saved_addresses)MyWallet.backupWallet()}this.invoke("on_error",e)},success:function(){this.invoke("on_success")}};e.addListener({on_error:function(e){console.log(e);if(e){MyWallet.makeNotice("error","tx-error",e)}},on_begin_signing:function(){this.start=(new Date).getTime()},on_finish_signing:function(){console.log("Signing Took "+((new Date).getTime()-this.start)+"ms")}});return e}try{if(typeof window=="undefined"||!window){var window={};self.addEventListener("message",function(e){var t=e.data;try{switch(t.cmd){case"seed":var n=Crypto.util.bytesToWords(Crypto.util.hexToBytes(t.seed));for(var r in n){rng_seed_int(n[r])}break;case"decrypt":var i=Crypto.AES.decrypt(t.data,t.password,{mode:new Crypto.mode.CBC(Crypto.pad.iso10126),iterations:t.pbkdf2_iterations});self.postMessage({cmd:"on_decrypt",data:i});break;case"load_resource":importScripts(t.path);break;case"sign_input":var s=new Bitcoin.Transaction(t.tx);var o=new Bitcoin.Script(t.connected_script);var u=signInput(s,t.outputN,t.priv_to_use,o);if(u){self.postMessage({cmd:"on_sign",script:u,outputN:t.outputN})}else{throw"Unknown Error Signing Script "+t.outputN}break;default:throw"Unknown Command"}}catch(e){self.postMessage({cmd:"on_error",e:exceptionToString(e)})}},false)}}catch(e){}